function [sys,x0,str,ts] = Test(t,x,u,flag,params,x_ic) 
 switch flag, 
	case 0, % initialization 
	 	sizes = simsizes; 
	 	sizes.NumContStates = 6; 	% number of continous states 
	 	sizes.NumDiscStates = 0; 	% number of discrete states 
	 	sizes.NumOutputs = 6; 	% number of system outputs 
	 	sizes.NumInputs = 3; 	% number of system inputs 
	 	sizes.DirFeedthrough = 0; 	% direct feedtrough flag 
	 	sizes.NumSampleTimes = 1; 	% at least one sample time is needed 
	 	sys = simsizes(sizes); 
 
	 	% initial conditions 
	 	x0 = x_ic; 
 
	 	str = []; % str is always an empty matrix
 
	 	ts = [0 0];% initialize the array of sample times 
 
	case 1, % derivative 
	 	g = params(1);
		m2 = params(2);
		m3 = params(3);
		s2 = params(4);
		s3 = params(5);
		l2 = params(6);
		l3 = params(7);
		BS1 = params(8);
		AS2 = params(9);
		BS2 = params(10);
		CS2 = params(11);
		AS3 = params(12);
		BS3 = params(13);
		CS3 = params(14);
		iG1 = params(15);
		iG2 = params(16);
		iG3 = params(17);
		BM1 = params(18);
		CM2 = params(19);
		CM3 = params(20);
		
	 	sys = zeros(6,1); 
		x0 = sin(x(2));
		x1 = cos(x(2));
		x2 = x0.*x1;
		x3 = m3.*x(5).^2;
		x4 = x2.*x3;
		x5 = sin(x(3));
		x6 = x5.^2;
		x7 = l2.^2;
		x8 = x6.*x7;
		x9 = x4.*x8;
		x10 = x(4).^2;
		x11 = m3.*x10;
		x12 = cos(x(1));
		x13 = x12.^4;
		x14 = l2.*x1;
		x15 = cos(x(3));
		x16 = x15.^3;
		x17 = s3.*x16;
		x18 = x14.*x17;
		x19 = x13.*x18;
		x20 = x(6).^2;
		x21 = m3.*x20;
		x22 = x15.^2;
		x23 = s3.*x22;
		x24 = l2.*x0;
		x25 = x24.*x5;
		x26 = x23.*x25;
		x27 = s3.*x15;
		x28 = x27.*x6;
		x29 = x14.*x28;
		x30 = sin(x(1));
		x31 = x30.^4;
		x32 = x11.*x31;
		x33 = x30.^2;
		x34 = x12.^2;
		x35 = x14.*x34;
		x36 = x33.*x35;
		x37 = 2*x36;
		x38 = x17.*x37;
		x39 = m2.*s2.^2;
		x40 = x10.*x2;
		x41 = x21.*x29;
		x42 = m3.*x31;
		x43 = x40.*x42;
		x44 = x22.*x7;
		x45 = m3.*x13;
		x46 = x40.*x45;
		x47 = x4.*x44;
		x48 = 2*x34;
		x49 = x33.*x48;
		x50 = x40.*x49;
		x51 = x28.*x37;
		x52 = g.*m3;
		x53 = x24.*x52;
		x54 = x11.*x13;
		x55 = x18.*x31;
		x56 = m3.*x44;
		x57 = x5.^3;
		x58 = s3.*x24.*x57;
		x59 = AS2.*x40 - BS2.*x40 - M2.*iG2 - g.*m2.*s2.*x0 - m3.*x50.*x8 - x11.*x19 - x11.*x38 - x11.*x51 - x11.*x55 - x13.*x41 - x13.*x47 - x13.*x9 - x19.*x21 + x21.*x26 - x21.*x38 - x21.*x51 - x21.*x55 + x21.*x58 - x22.*x53 - x29.*x32 - x29.*x54 - x31.*x41 - x31.*x47 - x31.*x9 - x39.*x40 - x43.*x44 - x43.*x8 - x44.*x46 - x46.*x8 - x47.*x49 + x47 - x49.*x9 - x50.*x56 - x53.*x6 + x9;
		x60 = -x24.*x30 - x27.*x30;
		x61 = x12.*x60;
		x62 = x12.*x24 + x12.*x27;
		x63 = x30.*x62;
		x64 = x15.*x61 + x15.*x63;
		x65 = x15.*x33;
		x66 = x14.*x65 + x15.*x35 - x25;
		x67 = m3.*x66;
		x68 = -x5.*x61 - x5.*x63;
		x69 = x14.*x5;
		x70 = -x15.*x24 - x33.*x69 - x34.*x69;
		x71 = m3.*x70;
		x72 = x64.*x67 + x68.*x71;
		x73 = x0.^2;
		x74 = 1./(AS2.*x1.^2 + AS3.*x6 + BM1.*iG1.^2 + BS1 + BS2.*x73 + BS3.*x22 + m3.*x64.^2 + m3.*x68.^2 + m3.*(x12.*x62 - x30.*x60).^2 + x39.*x73);
		x75 = 1./(CM2.*iG2.^2 + CS2 + m3.*x66.^2 + m3.*x70.^2 + x39 - x72.^2.*x74);
		x76 = s3.*x6;
		x77 = x23 + x33.*x76 + x34.*x76;
		x78 = x27.*x5;
		x79 = -x33.*x78 - x34.*x78 + x78;
		x80 = m3.*x64.*x79 + m3.*x68.*x77;
		x81 = x72.*x74;
		x82 = x67.*x79 + x71.*x77 - x80.*x81;
		x83 = x75.*x82.^2;
		x84 = 1./(CM3.*iG3.^2 + CS3 + m3.*x77.^2 + m3.*x79.^2 - x74.*x80.^2 - x83);
		x85 = x75.*(x83.*x84 + 1);
		x86 = x80.*x84;
		x87 = x75.*x82;
		x88 = -x74.*x80 + x81.*x87;
		x89 = x84.*x88;
		x90 = x75.*(-x81 - x82.*x89);
		x91 = 2*x(4);
		x92 = x(5).*x2;
		x93 = x91.*x92;
		x94 = x16.*x5;
		x95 = m3.*s3.^2;
		x96 = x13.*x95;
		x97 = x(4).*x(6);
		x98 = x96.*x97;
		x99 = x(6).*x91;
		x100 = x34.*x99;
		x101 = x100.*x95;
		x102 = x(4).*x45;
		x103 = x(5).*x102;
		x104 = x(4).*x42;
		x105 = x(5).*x104;
		x106 = x14.*x27;
		x107 = x102.*x92;
		x108 = m3.*x(5);
		x109 = x108.*x36.*x91;
		x110 = x15.*x5;
		x111 = x110.*x99;
		x112 = x(6).*x104;
		x113 = x57.*x65;
		x114 = x104.*x92;
		x115 = x13.*x58;
		x116 = m3.*x97;
		x117 = m3.*x33;
		x118 = x100.*x117;
		x119 = x31.*x95;
		x120 = x119.*x97;
		x121 = x34.*x93;
		x122 = s3.*x25;
		x123 = x7.*x92;
		x124 = x45.*x97;
		x125 = x15.*x57;
		x126 = x31.*x58;
		x127 = x117.*x121;
		x128 = -AS2.*x93 + AS3.*x111 + BS2.*x93 - BS3.*x111 - M1.*iG1 + x(4).*x108.*x19 - x101.*x113 - x101.*x33.*x94 - x101.*x5.*x65 + x102.*x123 + x103.*x106 + x103.*x29 + x104.*x123 + x105.*x106 + x105.*x18 + x105.*x29 + x107.*x44 + x107.*x8 + x109.*x17 + x109.*x27 + x109.*x28 - x110.*x120 - x110.*x98 - x112.*x122 - x112.*x26 + x114.*x44 + x114.*x8 - x115.*x116 - x116.*x126 - x118.*x122 - x118.*x26 - x118.*x58 - x120.*x125 - x120.*x94 + x121.*x33.*x56 - x122.*x124 - x124.*x26 - x125.*x98 + x127.*x7 + x127.*x8 + x39.*x93 - x94.*x98;
		x129 = x84.*x87;
		x130 = x10.*x15;
		x131 = x130.*x5;
		x132 = x26.*x3;
		x133 = x20.*x95;
		x134 = x133.*x94;
		x135 = x10.*x94;
		x136 = x125.*x133;
		x137 = x48.*x95;
		x138 = x130.*x57;
		x139 = x49.*x58;
		x140 = -AS3.*x131 + BS3.*x131 - M3.*iG3 + x10.*x113.*x137 + x11.*x115 + x11.*x126 + x11.*x139 + x11.*x26.*x49 + x113.*x133.*x48 + x115.*x3 + x119.*x135 + x119.*x138 + x126.*x3 + x13.*x132 + x13.*x134 + x13.*x136 + x132.*x31 + x132.*x49 + x134.*x31 + x134.*x49 - x134 + x135.*x137.*x33 + x135.*x96 + x136.*x31 - x136 + x138.*x96 + x139.*x3 + x17.*x52 - x18.*x3 + x26.*x32 + x26.*x54 + x28.*x52 - x29.*x3;
		x141 = x140.*x84;

		sys = [x(4); x(5); x(6); -x128.*x74.*(-x72.*x90 - x86.*x88 + 1) - x140.*x74.*(x129.*x72 - x86) - x59.*x74.*(-x72.*x85 + x86.*x87); -x128.*x90 + x141.*x87 - x59.*x85; -x128.*x89 + x129.*x59 - x141];
	case 3, % output 
	 	g = params(1);
		m2 = params(2);
		m3 = params(3);
		s2 = params(4);
		s3 = params(5);
		l2 = params(6);
		l3 = params(7);
		BS1 = params(8);
		AS2 = params(9);
		BS2 = params(10);
		CS2 = params(11);
		AS3 = params(12);
		BS3 = params(13);
		CS3 = params(14);
		iG1 = params(15);
		iG2 = params(16);
		iG3 = params(17);
		BM1 = params(18);
		CM2 = params(19);
		CM3 = params(20);
		
	 	sys = zeros(1,1); 
		x = [x(1); x(2); x(3); x(4); x(5); x(6)];
	case {2,4,9}, % unused flags 
	 	sys = []; 
	otherwise % unused flags 
	 	error(['Unhandled flag = ',num2str(flag)]); 
end