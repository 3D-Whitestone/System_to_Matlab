function [sys,x0,str,ts] = Test(t,x,u,flag,params,x_ic) 
 switch flag, 
	case 0, % initialization 
	 	sizes = simsizes; 
	 	sizes.NumContStates = 6; 	% number of continous states 
	 	sizes.NumDiscStates = 0; 	% number of discrete states 
	 	sizes.NumOutputs = 6; 	% number of system outputs 
	 	sizes.NumInputs = 3; 	% number of system inputs 
	 	sizes.DirFeedthrough = 0; 	% direct feedtrough flag 
	 	sizes.NumSampleTimes = 1; 	% at least one sample time is needed 
	 	sys = simsizes(sizes); 
 
	 	% initial conditions 
	 	x0 = x_ic; 
 
	 	str = []; % str is always an empty matrix
 
	 	ts = [0 0];% initialize the array of sample times 
 
	case 1, % derivative 
	 	g = params(1);
		m2 = params(2);
		m3 = params(3);
		s2 = params(4);
		s3 = params(5);
		l2 = params(6);
		l3 = params(7);
		BS1 = params(8);
		AS2 = params(9);
		BS2 = params(10);
		CS2 = params(11);
		AS3 = params(12);
		BS3 = params(13);
		CS3 = params(14);
		iG1 = params(15);
		iG2 = params(16);
		iG3 = params(17);
		BM1 = params(18);
		CM2 = params(19);
		CM3 = params(20);
		
	 	sys = zeros(6,1); 
		M1 = u(1);
		M2 = u(2);
		M3 = u(3);
		x0 = x(4).^2;
		x1 = m3.*x0;
		x2 = cos(x(1));
		x3 = x2.^4;
		x4 = cos(x(2));
		x5 = l2.*x4;
		x6 = cos(x(3));
		x7 = x6.^3;
		x8 = s3.*x7;
		x9 = x5.*x8;
		x10 = x3.*x9;
		x11 = sin(x(2));
		x12 = x11.*x4;
		x13 = m3.*x(5).^2;
		x14 = x12.*x13;
		x15 = sin(x(3));
		x16 = x15.^2;
		x17 = l2.^2;
		x18 = x16.*x17;
		x19 = x14.*x18;
		x20 = x(6).^2;
		x21 = m3.*x20;
		x22 = x6.^2;
		x23 = s3.*x22;
		x24 = l2.*x11;
		x25 = x15.*x24;
		x26 = x23.*x25;
		x27 = m2.*s2.^2;
		x28 = x0.*x12;
		x29 = sin(x(1));
		x30 = x29.^2;
		x31 = x2.^2;
		x32 = x31.*x5;
		x33 = x30.*x32;
		x34 = 2*x33;
		x35 = x34.*x8;
		x36 = s3.*x6;
		x37 = x16.*x36;
		x38 = x37.*x5;
		x39 = x21.*x38;
		x40 = x29.^4;
		x41 = x1.*x40;
		x42 = x17.*x22;
		x43 = m3.*x3;
		x44 = x28.*x43;
		x45 = x14.*x42;
		x46 = m3.*x40;
		x47 = x28.*x46;
		x48 = 2*x31;
		x49 = x30.*x48;
		x50 = x28.*x49;
		x51 = x34.*x37;
		x52 = g.*m3;
		x53 = x24.*x52;
		x54 = x1.*x3;
		x55 = x40.*x9;
		x56 = m3.*x42;
		x57 = x15.^3;
		x58 = s3.*x24.*x57;
		x59 = AS2.*x28 - BS2.*x28 - M2.*iG2 - g.*m2.*s2.*x11 - m3.*x18.*x50 - x1.*x10 - x1.*x35 - x1.*x51 - x1.*x55 - x10.*x21 - x16.*x53 - x18.*x44 - x18.*x47 - x19.*x3 - x19.*x40 - x19.*x49 + x19 + x21.*x26 - x21.*x35 - x21.*x51 - x21.*x55 + x21.*x58 - x22.*x53 - x27.*x28 - x3.*x39 - x3.*x45 - x38.*x41 - x38.*x54 - x39.*x40 - x40.*x45 - x42.*x44 - x42.*x47 - x45.*x49 + x45 - x50.*x56;
		x60 = -x24.*x29 - x29.*x36;
		x61 = x2.*x60;
		x62 = x2.*x24 + x2.*x36;
		x63 = x29.*x62;
		x64 = x6.*x61 + x6.*x63;
		x65 = x30.*x6;
		x66 = -x25 + x32.*x6 + x5.*x65;
		x67 = m3.*x66;
		x68 = -x15.*x61 - x15.*x63;
		x69 = x15.*x5;
		x70 = -x24.*x6 - x30.*x69 - x31.*x69;
		x71 = m3.*x70;
		x72 = x64.*x67 + x68.*x71;
		x73 = x11.^2;
		x74 = 1./(AS2.*x4.^2 + AS3.*x16 + BM1.*iG1.^2 + BS1 + BS2.*x73 + BS3.*x22 + m3.*x64.^2 + m3.*x68.^2 + m3.*(x2.*x62 - x29.*x60).^2 + x27.*x73);
		x75 = 1./(CM2.*iG2.^2 + CS2 + m3.*x66.^2 + m3.*x70.^2 + x27 - x72.^2.*x74);
		x76 = s3.*x16;
		x77 = x23 + x30.*x76 + x31.*x76;
		x78 = x15.*x36;
		x79 = -x30.*x78 - x31.*x78 + x78;
		x80 = m3.*x64.*x79 + m3.*x68.*x77;
		x81 = x72.*x74;
		x82 = x67.*x79 + x71.*x77 - x80.*x81;
		x83 = x75.*x82.^2;
		x84 = 1./(CM3.*iG3.^2 + CS3 + m3.*x77.^2 + m3.*x79.^2 - x74.*x80.^2 - x83);
		x85 = x75.*(x83.*x84 + 1);
		x86 = x80.*x84;
		x87 = x75.*x82;
		x88 = -x74.*x80 + x81.*x87;
		x89 = x84.*x88;
		x90 = x75.*(-x81 - x82.*x89);
		x91 = x(4).*x43;
		x92 = x(5).*x91;
		x93 = x15.*x7;
		x94 = m3.*s3.^2;
		x95 = 2*x(4);
		x96 = x(6).*x95;
		x97 = x31.*x96;
		x98 = x94.*x97;
		x99 = x(5).*x12;
		x100 = x95.*x99;
		x101 = x3.*x94;
		x102 = x(4).*x(6);
		x103 = x101.*x102;
		x104 = x(4).*x46;
		x105 = x(5).*x104;
		x106 = x36.*x5;
		x107 = x91.*x99;
		x108 = m3.*x(5);
		x109 = x108.*x33.*x95;
		x110 = x15.*x6;
		x111 = x110.*x96;
		x112 = x(6).*x104;
		x113 = x57.*x65;
		x114 = x104.*x99;
		x115 = x3.*x58;
		x116 = m3.*x102;
		x117 = m3.*x30;
		x118 = x117.*x97;
		x119 = x40.*x94;
		x120 = x102.*x119;
		x121 = x100.*x31;
		x122 = s3.*x25;
		x123 = x17.*x99;
		x124 = x102.*x43;
		x125 = x57.*x6;
		x126 = x40.*x58;
		x127 = x117.*x121;
		x128 = -AS2.*x100 + AS3.*x111 + BS2.*x100 - BS3.*x111 - M1.*iG1 + x(4).*x10.*x108 + x100.*x27 - x103.*x110 - x103.*x125 - x103.*x93 + x104.*x123 + x105.*x106 + x105.*x38 + x105.*x9 + x106.*x92 + x107.*x18 + x107.*x42 + x109.*x36 + x109.*x37 + x109.*x8 - x110.*x120 - x112.*x122 - x112.*x26 - x113.*x98 + x114.*x18 + x114.*x42 - x115.*x116 - x116.*x126 - x118.*x122 - x118.*x26 - x118.*x58 - x120.*x125 - x120.*x93 + x121.*x30.*x56 - x122.*x124 + x123.*x91 - x124.*x26 + x127.*x17 + x127.*x18 - x15.*x65.*x98 - x30.*x93.*x98 + x38.*x92;
		x129 = x84.*x87;
		x130 = x0.*x6;
		x131 = x130.*x15;
		x132 = x20.*x94;
		x133 = x132.*x93;
		x134 = x13.*x26;
		x135 = x0.*x93;
		x136 = x125.*x132;
		x137 = x48.*x94;
		x138 = x130.*x57;
		x139 = x49.*x58;
		x140 = -AS3.*x131 + BS3.*x131 - M3.*iG3 + x0.*x113.*x137 + x1.*x115 + x1.*x126 + x1.*x139 + x1.*x26.*x49 + x101.*x135 + x101.*x138 + x113.*x132.*x48 + x115.*x13 + x119.*x135 + x119.*x138 + x126.*x13 + x13.*x139 - x13.*x38 - x13.*x9 + x133.*x3 + x133.*x40 + x133.*x49 - x133 + x134.*x3 + x134.*x40 + x134.*x49 + x135.*x137.*x30 + x136.*x3 + x136.*x40 - x136 + x26.*x41 + x26.*x54 + x37.*x52 + x52.*x8;
		x141 = x140.*x84;

		sys = [x(4); x(5); x(6); -x128.*x74.*(-x72.*x90 - x86.*x88 + 1) - x140.*x74.*(x129.*x72 - x86) - x59.*x74.*(-x72.*x85 + x86.*x87); -x128.*x90 + x141.*x87 - x59.*x85; -x128.*x89 + x129.*x59 - x141];
	case 3, % output 
	 	g = params(1);
		m2 = params(2);
		m3 = params(3);
		s2 = params(4);
		s3 = params(5);
		l2 = params(6);
		l3 = params(7);
		BS1 = params(8);
		AS2 = params(9);
		BS2 = params(10);
		CS2 = params(11);
		AS3 = params(12);
		BS3 = params(13);
		CS3 = params(14);
		iG1 = params(15);
		iG2 = params(16);
		iG3 = params(17);
		BM1 = params(18);
		CM2 = params(19);
		CM3 = params(20);
		
	 	sys = zeros(6,1); 
		M1 = u(1);
		M2 = u(2);
		M3 = u(3);
		out1 = x(1) + x(2)./x(3);
		sys = [x(1); x(2); x(3); x(4); x(5); x(6); out1];
	case {2,4,9}, % unused flags 
	 	sys = []; 
	otherwise % unused flags 
	 	error(['Unhandled flag = ',num2str(flag)]); 
end